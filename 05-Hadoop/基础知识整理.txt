一、财务集市
财务集市整体
    经营性
    非经营性
        工资、固定资产、采购
    
    业务环节
        业务系统
            放款
            计提(日结)
            还款
            余额
            逾期
            冲销
            退款

            信托SPV
            资产ABS
        结算系统
            计提
            冲销
            实收
            实付
            退款

    信息流

    资金流
        韩路路文件
        凌艳花文件


    银行流水

    业务类型
        从整体的信息流、资金流考虑，识别财务关注的业务环节
    资金类型
        在各个财务相关业务环节中，识别财务关注的不同款项类型，定义为资金类型


供应链业务过程
    1、企金业务
        围绕核心企业的上下游进行融资

    2、角色
        核心企业
            按照还款能力&还款意愿，为核心企业评估额度。
            给谁评估额度，谁叫核心企业。
        供应商
        经销商
        JDT(科技)
        
    3、保理：反向保理&正向保理
        正向保理：核心企业的应收账款转让给科技
        反向保理：核心企业的应付账款转让给科技
        企金各业务都可以归类到正向保理&反向保理
    
    4、业务分类
        信用贷款(信贷类)
            保理
                需要保理牌照
                以受让应收账款&订单池的方式提供贸易融资
                保理发生了应收账款的转让
            小贷
                需要小贷牌照
                可以给债权人融资
                可以给债务人融资
                通过对客户的信用风险进行评估，对客户进行信用贷款，也有部分是抵押贷款(动产质押)
                小贷未发生应收账款的转让
                
                外部小贷
                    针对外部平台介绍的客户进行放贷
                内部小贷
					针对内部POP商户进行放贷
            采购融资
                需要小贷牌照
                商户依据采购订单向京东贷款，贷款发放时定向支付给卖方，同时需要商户还款后，京东才发出指令要求卖家发货。
                这种融资一般卖家发货时间比较长，货物可能需要现做，周期比较长。
                
            融资租赁
                直租
                    贷款人指定想要购买的商品或者服务，由JDT融资租赁主体出钱购买，所有权在JDT主体，然后将该商品或者服务，出租给融资人使用，融资人按协议期限，按期给交租金(还款)(会包含本金+利息+服务费等)，等租赁期限结束后，JDT会按照协议处理租赁商品或服务(一般是100卖给租赁方，因为这种方式JDT本身是为了保证贷款资产安全，而不是为了获取商品，租赁结束后就是象征性的收点钱)。
                售后回租
                    贷款人不指定想要购买的商品或服务，而是将自己所有的物品，卖给JDT，然后JDT再将该物品出租给融资人使用，融资人按协议期限，按期给交租金(还款)(会包含本金+利息+服务费等)，等租赁期限结束后，JDT会按照协议处理租赁商品或服务(一般是100卖给租赁方，因为这种方式JDT本身是为了保证贷款资产安全，而不是为了获取商品，租赁结束后就是象征性的收点钱)。
                其实只是一种融资方式而已
        
        抵押贷款(质押贷款)
            动产质押
                需要小贷牌照
                客户将货物存在京东指定的仓库中进行质押，向京东贷款，在客户还款后，释放仓库中的货物，如未还款，将处置仓库中的货物。
            
            
        
        平台类
            对公理财
            票据融资
                票据持有人使用票据进行融资
        
        信托委贷SPV
            由于小贷主体放款存在限额，无法满足各业务线放贷需求，业务侧分别发行信托计划开展信托委贷。
            
            
            
        融资类(资产证券化ABS)
            将 信贷类、平台类、抵押贷款、信托委贷，各类贷款资产通过资产证券化(ABS)，转让收益权等方式获得融资款项
            出表ABS：不入资产负债表
            不出表ABS：入资产负债表
            
            信托出表ABS
            信托不出表ABS
            单家出表ABS
            单家不出表ABS
        
        回购(宿迁达润)&FV回购&兜底代偿(汇正融担)
            回购：发行了ABS，进了ABS资产池的贷款单，如果在发行ABS的时候有协议，在贷款单出现不良情况(比如逾期)的时候，需要JDT自己的内部主体出资进行贷款单回购，回购后的贷款单需要进行资产出池操作，所有权转到回购主体。
            置换：发行了ABS，进了ABS资产池的贷款单，如果在发行ABS的时候有协议，在贷款单出现不良情况(比如逾期)的时候，需要拿同产品的优良资产和资产池里面的不良资产进行置换操作，优良资产置换入池，不良资产置换出池，另外需要JDT支付置换资产的差价。
            FV回购：当已经发行的ABS计划，出现了特殊变动(比如监管要求、JDT后续肯定亏钱的情况等)的时候，发行ABS的主体可以根据协议，对该ABS涉及所有贷款单资产进行清仓回购。
            兜底代偿：部分ABS计划，在签协议的时候，会写明，所有出现不良的资产，全部有JDT内部主体进行回购，叫兜底代偿。如果发生了兜底代偿，然后又有了还款，叫代偿后还款。
            
        坏账
            坏账计提
            坏账核销
            核销后还款
            
        
        
        小贷&融资租赁&商票秒融&动产质押&保理 企金各业务拆分：
            同一个主体，对于不同客户，根据客户业务模式，客户经营方式，使用不同的业务模式为客户进行融资
            由于资质牌照、放款额度等问题，可能都要配合信托进行放贷
            放贷后拿贷款单，作为资产，都可以发行ABS，进行资产证券化。
            
    专业名词
        单家：公司内部的放贷主体、成立信托计划的内部出资主体
        信托：小贷单家主体拿一部分资产，成立一个信托计划(对于一个产品)，委托一个信托公司使用这个信托计划的资产进行放贷
        SPV：在证券行业，SPV指特殊目的的载体，也称为特殊目的机构/公司，其职能是在离岸资产证券化过程中，购买、包装证券化资产和以此为基础发行资产化证券，向国外投资者融资
        资产：成立信托计划所拿资产一般会固定取某一个或几个产品，一般不会一个产品对应多个信托计划
        联合贷：
            内部资方+外部资方 联合放贷，按照一定出资比例
            信托计划+外部资方 联合放贷，按照一定出资比例
        ABS：资产证券化
        出表/不出表：表指的是资产负债表
        资产负债表：包括流动资产，长期资产，无形、递延资产，流动负债，长期负债，所有者权益几大项
        表内业务：就是指在资产负债表上反映的业务。比如银行存款、贷款等。一般认为贷款和存款涉及银行资产和负债，为表内业务，结算业务不涉及资产负债，为表外业务。
        表外业务：是不在资产负债表上反映，但是在一定时期可以转化成资产负债表上的内容的或有负债业务。比如：担保业务、承诺业务。表外业务也称为中间业务。
        
    

供应链业务环节
    业务系统
        放款
        计提(日结)
        还款
        余额
        逾期
        冲销
        退款
        
        信托SPV
        资产ABS
    结算系统
        计提
        冲销
        实收
        实付
        退款

供应链业务模式&数据流(信息流&资金流)
    业务模式：业务信息流
        业务过程中单纯记录业务流程的步骤，不涉及任何资金变更，不涉及数据信息流&数据资金流。
    业务模式：业务资金流
        业务过程中记录资金变更流程的步骤，涉及数据信息流&数据资金流。平时说的信息流&资金流，说的就是这一步里面的系统变更记录和资金变更记录。
    数据信息流
        业务过程中，业务资金流变更步骤中，记录系统信息变更的步骤。
    数据资金流
        业务过程中，真实资金流发生变更的过程，会在资金系统和银行流水中进行记录
        资金系统：JDT记录真实资金变更的地方
        银行流水：银行记录的真实资金变更的信息，会回传给JDT
    
    小贷
        信息流
        资金流
    
    融资租赁
        参与方
            承租人
            JDT出租人
            厂商
            保司/担保机构
        
        业务模式
            信用评估&额度评估
                1、核心企业额度评估：承租人(保证人+抵押物)增信+额度评估+受信申请+授信评估
            业务信息流
                2、承租人>>JDT出租人：签订合同《融资租赁合同》
                3、JDT出租人>>厂商：购买租赁物，取得所有权
            业务资金流
                4、承租人>>JDT出租人：支付保证金+手续费
                5、承租人>>JDT出租人：支付首付款
                6、JDT出租人>>厂商：支付采购款
                7、承租人>>JDT出租人：支付租前息(如有)
            业务信息流
                8、厂商>>承租人：租赁物交付与维护
            业务资金流
                9、承租人>>JDT出租人：支付保险费(如有)
                10、承租人>>JDT出租人：按期支付租金
                11、承租人>>JDT出租人：到期支付留购价款
            业务信息流
                9、JDT承租人>>保司/担保机构：代付保险费(如有)
                9、保司/担保机构>>承租人：提供保险/担保(如有)
            
            
        
        数据信息流(信息记录的过程)
            1、放款：快速放款系统/融资租赁系统>>供应链核心台账>>资金路由(对接收付款平台(对接真实资金收付)&触发资金账)
            2、还款：快速放款系统/融资租赁系统>>供应链核心台账>>资金路由(对接收付款平台(对接真实资金收付)&触发资金账)
            3、其它款项：结算系统>>收付款系统(对接真实资金收付&触发资金账)
        数据资金流(资金变更的过程)
            1、收取保证金、预收服务费、收取租金(还款)、收取留购价款、代收保险费、首付款收款：承租人对公户>>广州知骏对公户
            2、退还保证金、放款：广州知骏对公户>>承租人对公户
            3、代付保险费：广州知骏对公户>>保司对公户
            4、首付款付款：广州知骏对公户>>厂商对公户

        收入&成本&服务费等
            收入：
                租赁利息收入：按期结转未实现融资收益
                罚息收入：如有，万五/日
                资金占用利息：起租日前购买租赁物资产时的生息
            成本：
                资金占用成本
                资产减值损失
            其它：
                服务费、保证金、提前还款手续费等
        
        业务总结
            融资租赁业务系统：
                合同管理
                客户管理(超级账户>>客商主数据)
                产品管理(对接山海系统(产品主数据))
                放款管理(对接核心台账)
                日结管理(对接核心台账)
                还款管理(还款计划)(对接核心台账)
                其它款项(对接结算系统)
            核心台账：
                放款记录(调用资金路由)
                日结记录
                还款计划记录
                还款记录(调用资金路由)
            结算系统：
                其它款项记录(对应融资租赁业务系统记录)(调用收付款系统)
            资金系统：
                放款记录(对应台账记录)(对应银行流水)
                还款记录(对应台账记录)(对应银行流水)
                其它款项记录(对应结算系统)(对应银行流水)
        
        财务入账&财务集市：
            核心台账：
                放款记录
                计提&日结记录
                还款记录
            结算系统：
                其它款项(保证金&保险费等)
        
        业财核对&资金核对
            集市入账数据
            资金系统
                

供应链数仓建设
    整体
        明细整合
            营销
            授信
            放款
                客户账
                主体账
            计提(日结)
                客户账
                主体账
            还款
                客户账
                主体账
            逾期
            余额
            贷款单
                分期单
                贷款单
        维度
            客户
            产品
        指标汇总
    
    采购融资
    应收融资
    核心台账
    动产质押
    农村金融


供应链集市建设
    单独业务，单独脚本，分开建设
    集市模型整合
    

供应链集市改造
    财务口径整合
        支持多模块
        财务核算
        财务管报
        业绩周报
        星空指标


结算模型
    特殊逻辑整合：配置化加工
    结算模型整合：配置化加工
    结算数据使用逻辑整合：配置加工
    三层配置将结算集成逻辑完全配置化，支持80%左右的需求变更
    
支付业务过程
        各业务比较散，相互之间没有很大的关联性。集市的加工可以看成类似指标的加工方式。每个业务系统获取几个摘要(指标)的数据，单独进行开发加工逻辑。
        今年做过两个事。
        支付流水层，接口层模型开发，准备进行支付底层模型的整合。但是支付之前的业务需求比较多，但是现在的需求比较少，所以只是哪了一个旧业务，一个新业务进行了开发。没有做大批量的需求改造整合。
        清结算模块，之前由于历史原因，同一个业务系统的数据，相同的表，做了三套逻辑，集市两套，管报一套，逻辑类似。今年把集市的两套逻辑进行了整合，并且开发了一套业务系统数据加工逻辑的统一逻辑，包含了业务来源表的整合和按月冲销逻辑的标准化，可以支持任意表加工逻辑的套用，自己试用过。


层级建设
    现状
        各业务线单独开发，逻辑散乱
        各模块单独从业务系统取数，口径不统一
    改造
        集市逻辑整合，通过基础层整合实现
        财务口径整合，支持多模块口径同源，减少数据差异，数据核对
        

质量校验dqc
    数仓校验
        贴源层、基础层校验、基本都是通过大数据平台的基础校验功能。例如：零熔断、换行符、数据串行等
    集市作业监控
        通过大数据平台作业监控、基线监控，保证作业运行稳定性，及时发行运行异常
    数据质量校验
        财务运行平台：
            差异配置化校验(通过日常校验，找出可以通过配置进行数据质量校验的点)
            SQL语句配置化校验(通过日常校验，找出可以通过SQL配置进行数据质量校验的点)
        凭证校验：通过模板化脚本校验
        UDF校验：
            异常交易明细
            异常凭证校验
            日凭证借贷一致校验
        日月凭证校验：通过帆软报表校验
        
    
接口层
    统一T0&T1对接逻辑，方便后期进行T0&T1整合凭证生成方式

数据漂移
数据膨胀
    金额膨胀问题


二、模型设计
业务模型
    业务梳理、集成范围限定
概念模型
    主题设计&主题接口(连接器)设计
逻辑模型
    丰富主题实体、属性、实体关系
    ER模型
物理模型
    表结构设计、分区设计、存储优化
    建立数据仓库的物理模型，确定数据仓库的存储结构、数据的存储位置和索引策略。

维度建模
    事实表&维度表 维度&度量
    星型模型
        一个事实表&多个维度表(维度表不再分)
    雪花模型
        一个事实表&多个维度表(维度表依据范式模型再次进行拆分)
    星座模型
        多个事实表&多个维度表
    优缺点
        星型模型-优点：
            针对各维表会进行大量的预处理，提高关联效率
        星型模型-缺点：
            对比雪花模型，冗余更多，占用存储空间比较多
        雪花模型-优点：
            对比星型模型，冗余更少，减少存储空间，层次性好
        雪花模型-缺点：
            对比星型模型，需要进行更多的预处理，逻辑更加复杂；使用的时候需要更多的关联，关联效率更低；
        
        2.4、两种模型比较(星型模型&雪花模型)
            1) 星型模型通过预连接和建立有选择的数据冗余，为用户访问和分析过程大大简化了数据。
            2) 星型模型效率比较高，因为雪花模型维表层次多，查询的时候连接操作较多。
            3) 雪花模型通过最大限度的减少数据存储量以及联合较小的维表来改善查询性能。
            4) 雪花模型增加了用户必须处理的表数量，增加了某些查询的复杂性，但这种方式可以使系统进一步专业化和实用化，同时降低了系统的通用程度。 
            5) 雪花模型的维表可能是规范化形式，以便减少冗余，易于维护，节省存储空间。

        2.5、两种模型选项建议： 
            1) 星型模型结构效率上优于雪花模型，首选星型模型
            2) 如果存储空间上存在瓶颈，可以考虑使用雪花模型
            3) 如果维护方面要求简便性，可以考虑使用雪花模型
    
    和关系模型区别

关系模型

数仓分层建设原因
    1、清晰数据结构
        每个层级都有各自的作用域。我们在使用表的时候能更方便的定位和理解
    2、方便数据血缘追踪
        数仓下游有各种各样的应用和报表。某一个表出问题的时候，根据血缘关系，可以很快速的定位到出问题的地方
    3、减少重复开发
        规范数据分层，开发一些通用的中间模型，可以减少很多重复的开发
    4、复杂问题简单化
        可以把一个复杂的问题，拆分成很多简单的问题来处理。每一层只处理一个简单步骤，便于维护数据准确性。当数据出问题不用整体全部修复，从出问题的地方开始修复即可
    5、屏蔽原始数据的变更和异常
        当原始业务系统发生什么变更或者出现数据异常，可以在和原始数据对接的层级里面进行屏蔽或者改造。一般不必改造所有层级的逻辑。

模型设计流程
    1、模型：所谓模型，即为入仓模型，也就是数据仓库模型。
    2、数据仓库模型：按系统分析、按主题划分；对系统进行表级分析，入十大主题；对表进行字段级分析，分析字段是否入仓，入仓字段是否抽取整合；
    3、模型字段级分析：
        1) 是否入仓：一张入仓表中，总有一些字段是无用的，即为不需入仓字段，其余字段入仓。
        2) 是否整合：一张表的入仓字段中总有一些字段是可以抽取出来和其它表的字段进行整合的，整合而成的表或是宽表（主表）、或是窄表。
    4、模型宽表：存储一些基本信息的表（一般基本信息字段较多）。例如：当事人基本信息表（存储所有类型客户的基本信息）。
    5、模型窄表：存储某一个基本信息的表（一般主要是为了存储一项信息）。例如：当事人物理地址信息表（存储所有类型客户的物理地址信息）。
    6、模型表的整合：可以有两种方式的整合。
        1) 抽取一些表的共性字段，得出共性表。
        2) 关联一些表得出一些可以放到同一张表中的字段。
    7、模型设计
        业务驱动（根据业务需求：例如配合绩效供数、存贷款标准化报送等）
        数据驱动（根据已有模型样例参考（例如TD模型），从源系统确定入仓整合表）

建模过程
	梳理了解业务模式、业务逻辑
	确定建模目标、模型覆盖范围
	找业务研发沟通，梳理业务模式对应业务库表及数据流程。
	分析现有模型及取数范围(业务系统&业务范围&业务库表)
	分析业务库表及关联关系，梳理交易表&维表等关系
	梳理需求覆盖范围和已有模型覆盖范围的业务重合度、模型字段重合度、确认是使用已有模型扩展业务范围、字段范围，还是需要新建模型进行处理

	整合现有模型
	梳理新业务模式涉及库表中，事实表相关维度字段、度量字段，维度表相关字段及维度值范围。确认需要整合的维度、度量字段
	按照现有模型建模方式进行整合开发。例如：星型模型、雪花模型


	开发新模型
	梳理全流程涉及交易数据、以及相关维度，进行各环节公共字段提取，维度类型拆分。
	公共字段


三、hive优化
    优化方式详情
        map&reduce 数量控制、小文件问题处理
            map阶段：
                文件输入，split分割，大文件分割、小文件合并，优化map数量，解决小文件问题
                map结束后小文件合并，合并文件大小设置
            
            reduce阶段：
                reduce处理文件大小设置、reduce数量最大值、reduce数量直接指定
                reduce结束后小文件合并
        
        传输文件压缩
            shuffle阶段
                传输之前压缩map文件、传输之后解压缩文件。参数控制
            
            job之间
                临时文件读取传输之前压缩文件、读取传输之后解压缩文件
            
        jvm重用
            小文件问题，map数很多的时候，开启jvm重用，节省jvm资源
        
        GC&OOM内存溢出
            调整map阶段、reduce阶段，内存大小、jvm大小
        
        job并行
            有很多union all的时候，可以开启job并行，指定并行数量，减少运行时间
        
        关联键
            多个表join的时候，如果可以将关联键使用的一样，可以使用一个job进行数据处理
        
        mapjoin
            小表和大表关联的时候，可以通过控制小表文件大小限制、mapjoin开关限制，使用mapjoin在map阶段进行join操作，减少shuffle步骤及reduce步骤
        
        join顺序
            小表在前，大表在后，扫描小表到内存，依次关联右边大表。这里的大表是驱动表，可以通过声明指定驱动表
        
        倾斜优化
            关联键(大量空值(过滤处理)、大量重复值(加关联键打散数据、mapjoin处理)、小表关联键在大表大量存在(mapjoin、去重处理))
            group by 字段大量重复

map端聚合
内存

groupby 参数负载均衡

        
            
        
        本地模式、严格模式
        非等值join：笛卡尔积，只有一个reduce
        order by : 全局排序，一个reduce
        
        
    优化样例

    mr排序次数及情况
        1、map循环缓冲区溢写到磁盘
        2、map溢写文件合并，传输给reduce
        3、reduce多来源partition合并

分析函数
    排序方式
        row_number() : 非并列排序、非跳跃排序
        rank() : 并列排序、跳跃排序
        dense_rank() : 并列排序、非跳跃排序
        
        first_value() : 获取指定列第一行
        last_value() : 获取指定列最后一行
        lag() : 获取上一个
        lead() : 获取下一个
    窗口函数
        over(partition by ... order by ...)
            如果没有order by ，相当于对分组后的每一行对整个窗口执行获取结果，每一行结果一样
            如果没有partition by ，相当于不分组，全局排序
    关键词
        range proceding following
            窗口按照取值范围处理
            range between 5 preceding and 5 following
                数据窗口是本行数据值之前4，本行数据值之后5
            range between unbounded preceding and unbounded following
                按取值范围，前无边界，后无边界
        rows preceding following
            窗口按照行范围处理
            rows between 2 preceding and 4 following
                数据窗口是本行之前一行，本行之后4行
            rows between unbounded preceding and unbounded following
                按行范围，前无边界，后无边界
        
        partition by 
        order by